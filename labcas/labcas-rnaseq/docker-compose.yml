# docker-compose configuration for running the labcas-test workflow
# requires the following env variables to be set to local directories:
# RNASEQ_DATA_DIR: location of input RNAseq data
# LABCAS_STAGING: location of temporary output products before publishing
# LABCAS_ARCHIVE: final location of published files
# example:
# export RNASEQ_DATA_DIR=/usr/local/edrn/data/RNAseq
# export LABCAS_ARCHIVE=/usr/local/edrn/data/archive
# export LABCAS_STAGING=/usr/local/edrn/data/staging

version: '2'

services:

  # OODT File Manager + LabCAS configuration
  oodt_filemgr_app:
    env_file: labcas.env
    image: oodthub/oodt-filemgr
    container_name: oodt_filemgr
    expose:
      - "9000"
      - "8983"
    ports:
      - "8983:8983"
      - "9000:9000"
    volumes:
      - $PWD/filemgr/etc/filemgr.properties:/usr/local/oodt/cas-filemgr/etc/filemgr.properties
      - $PWD/common/labcas-backend-common-0.7.jar:/usr/local/oodt/cas-filemgr/lib/labcas-backend-common-0.7.jar
      - $LABCAS_STAGING:/usr/local/oodt/staging
      - $LABCAS_ARCHIVE:/usr/local/oodt/archive
    volumes_from:
      - oodt_wmgr_app
    networks:
      default:
        aliases:
          - oodt.filemgr.host

  # OODT Workflow Manager + LabCAS configuration + LabCAS executable
  oodt_wmgr_app:
    env_file: labcas.env
    environment:
      - RNASEQ_DATA_DIR=/data/EDRN/RNAseq
    # IMPORTANT: use labcas image with all RNAseq PGEs installed
    #image: oodthub/oodt-wmgr
    image: oodthub/labcas-rnaseq
    container_name: oodt_wmgr
    expose:
      - "9001"
    ports:
      - "9001:9001"
    volumes:
      - $PWD/wmgr/etc/workflow.properties:/usr/local/oodt/cas-workflow/etc/workflow.properties
      - $PWD/common/labcas-backend-common-0.7.jar:/usr/local/oodt/cas-workflow/lib/labcas-backend-common-0.7.jar
      - $RNASEQ_DATA_DIR:/data/EDRN/RNAseq
      - $LABCAS_STAGING:/usr/local/oodt/staging
      - $LABCAS_ARCHIVE:/usr/local/oodt/archive
    networks:
      default:
        aliases:
          - oodt.wmgr.host

  # OODT Product Server
  oodt_fmprod_app:
    env_file: labcas.env
    image: oodthub/oodt-fmprod
    container_name: oodt_fmprod
    expose:
      - "8080"
    ports:
      - "8080:8080"
    volumes_from:
      - oodt_wmgr_app
    networks:
      default:
        aliases:
          - oodt.fmprod.host
